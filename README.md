# MRP（物料需求计划）Excel 实施方案

本项目提供一套基于 Excel 的 MRP 与下单决策方法，聚焦“动态安全库存 + 定期盘点系统（P=1月）”。无需编码，直接按模板在 Excel 中落地，帮助在月度下单场景下稳定服务水平并合理控制库存。

- 默认服务水平因子：Z = 1.65（约 95% 服务水平）
- 建议滚动窗口：W = 6 或 12 个月（视数据量与业务习惯选择其一并保持一致）

参考文档：`excel_formulas_template.md`、`mrp_excel.md`、`计算MRP公式.md`


## 业务场景与数据
- 每月一次下单，订单通常在 1–2 个月内到货。
- 目标：在满足服务水平的前提下，动态设定安全库存并按月确定下单量。
- 数据来源：`data/rawdata.xlsx`（示例数据）。
- 样例产品：
  - 产品A：LD公司 50KA
  - 产品B：B公司 10LL


## 目录结构
- `data/`：原始数据（`rawdata.xlsx`、`rawdata.txt`）
- `excel_formulas_template.md`：Excel 模板与单元格公式布局
- `mrp_excel.md`：业务与计算示例（A/B 两产品）
- `计算MRP公式.md`：方法论与公式推导（动态安全库存 + 定期盘点）
- `excel_mode/`、`output/`：预留目录


## Excel 快速上手（无代码）
1) 新建 3 个工作表
- RawData：导入 `data/rawdata.xlsx`
- Calculations：放置计算字段与参数
- Summary：汇总安全库存与下单建议

2) 在 Calculations 放置模板区域（以产品A为例）
- 基础数据区：A1:M20
- 参数区：A22:D30
- 9月下单计算：A32:D40
- 产品B从列 F 开始（F1:M20、F22:I30、F32:I40）

3) 配置 Summary
- 引用 Calculations 中的安全库存与下单量，生成汇总表

4) 设置数据验证与条件格式（见下文“数据验证与条件格式”）

5) 月度更新
- RawData 添加当月数据 → 计算区滚动重算 → Summary 出结果 → 备份


## 核心公式（数学与 Excel 口径）
- 总需求
    $$
    D_t = S_t + S_other_t + OUT_other_t
    $$
    
```
D_t = S_t + S_other_t + OUT_other_t
```
- 参数解释
  - D_t：当月总需求（千件）
  - S_t：当月交货量（本客户，千件）
  - S_other_t：当月其他客户交货量（千件）
  - OUT_other_t：当月其他出库量（千件）
- 示例（产品A，1月）：S=175，S_other=40，OUT=0 → D_1 = 175 + 40 + 0 = 215（千件）

- 预测误差与修正预测
```
e_t = F_t - D_t
bias = AVERAGE(最近窗口的 e_t)
σ_error = STDEV.S(最近窗口的 e_t)
F*_t = F_t + bias
```
- 参数解释
  - F_t：当月预测交货数量（千件）
  - e_t：预测误差（千件）
  - bias：最近 W 个月误差 e 的平均值（滚动偏差，千件）
  - σ_error：最近 W 个月误差 e 的样本标准差（千件）
  - F*_t：修正后的预测（千件）
  - W：滚动窗口长度，建议 6 或 12 个月，并在全流程保持一致
  - Excel 对应：`AVERAGE(...)`、`STDEV.S(...)`
- 示例（产品A，W=6）
  - bias ≈ -126.17，σ_error ≈ 64.73
  - 9月修正预测：72.5 + (-126.17) = -53.67
  - 10月修正预测：62.5 + (-126.17) = -63.67
  - 11月修正预测：60 + (-126.17) = -66.17（千件）

- 提前期估算（基于到货/订单比例）
```
p1 = MEDIAN(R_t / O_{t-1}) 截断到 [0,1]
p2 = MAX(0, 1 - p1)
LT = 1×p1 + 2×p2
```
- 参数解释
  - R_t：当月收货数量（千件）
  - O_{t-1}：上月订单数量（千件）
  - R/O_{t-1}：当月收货对上月订单的比率（无量纲）
  - p1：最近 W 个月 R/O 的中位数，截断到区间 [0,1]
  - p2：补偿项，`p2 = max(0, 1 - p1)`
  - LT：加权平均提前期（月）。`LT=1×p1+2×p2` 表示 1 月或 2 月到货的加权组合
  - Excel 对应：`MEDIAN(...)` + `MIN/MAX` 截断
- 示例（产品A）
  - 近月 R/O 样本（见文档）：0.76、0.97、1.15、0.30 ...
  - p1 ≈ 0.866，p2 ≈ 0.134 → LT = 1×0.866 + 2×0.134 = 1.134（月）

- 动态安全库存（当月）
```
SS_t = Z × σ_error × √LT
```
- 参数解释
  - Z：服务水平因子（默认 1.65 ≈ 95% 服务水平）
  - σ_error：最近窗口预测误差标准差（千件）
  - LT：平均提前期（月）
- 示例（产品A）
  - SS = 1.65 × 64.73 × √1.134 ≈ 113.75（千件）

- 覆盖期与目标水位（P = 1 月）
```
H = P + LT = 1 + LT
令 H = h + φ（h 为整数，φ 为小数部分）

覆盖期需求：
D_H = SUM(F*_{t+1} ... F*_{t+h}) + φ × F*_{t+h+1}

覆盖期安全库存：
SS_H = Z × σ_error × √H

预计在途到货（EARR）：
EARR = p2×O_{t-2} + (p1+p2)×O_{t-1}

目标水位：
M = D_H + SS_H

下单量：
Q_t = MAX(0, M - I_end_t - EARR)
```
- 参数解释
  - P：审视周期（本项目 P=1 月）
  - H：覆盖期（月），`H=1+LT`，分解为 `h=INT(H)` 与 `φ=H-h`
  - F*_{t+i}：第 i 个月修正预测（千件）
  - D_H：覆盖期需求（千件）
  - SS_H：覆盖期安全库存（千件）
  - O_{t-1}、O_{t-2}：近两月订单（千件），用于预计在途到货
  - EARR：预计在途到货（千件）
  - I_end_t：t 月期末库存（千件）
  - M：目标水位（千件）
  - Q_t：下单量（千件），小于 0 按 0 处理
- 示例（产品A，t=8月末）
  - LT ≈ 1.134 → H = 2.134 → h=2，φ=0.134
  - D_H = (-53.67) + (-63.67) + 0.134×(-66.17) ≈ -126.21
  - SS_H = 1.65 × 64.73 × √2.134 ≈ 156.02
  - M = -126.21 + 156.02 ≈ 29.81
  - I_end_t = 1191.90，EARR = 0 → Q = MAX(0, 29.81 - 1191.90 - 0) = 0（千件）
- 示例（产品B，t=8月末）
  - σ_error ≈ 285.96，LT ≈ 1.094 → H = 2.094
  - D_H ≈ 465.07，SS_H ≈ 682.77 → M ≈ 1147.84
  - I_end_t = 833.82，O_{t-2} = 146.25，O_{t-1} = 0，p2 ≈ 0.094 → EARR = 0.094×146.25 ≈ 13.75
  - Q = MAX(0, 1147.84 - 833.82 - 13.75) ≈ 300.27（千件）


## 模板落地（关键单元格示例）
以 `excel_formulas_template.md` 为准，摘录要点（产品A）：
- 基础数据区（A1:M20）
  - F 列总需求：`F2 = C2 + D2 + E2`
  - G 列预测误差：`G2 = B2 - F2`
  - J 列 R/O 比：`J3 = IF(H2>0, I3/H2, "")`
- 参数区（A22:D30）
  - 偏差：`B22 = AVERAGE(G2:G8)`
  - 标准差：`B23 = STDEV.S(G2:G8)`
  - p1：`B24 = MIN(MAX(MEDIAN(J3:J8),0),1)`
  - p2：`B25 = MAX(0, 1 - B24)`
  - LT：`B26 = 1*B24 + 2*B25`
  - 安全库存：`B27 = 1.65 * B23 * SQRT(B26)`
  - 覆盖期：`B28 = 1 + B26`
- 9 月下单（A32:D40）
  - 修正预测（9/10/11 月）：`= 当月预测 + $B$22`
  - H、h、φ：`B38 = $B$28`，`B39 = INT(B38)`，`B40 = B38 - B39`
  - 覆盖期需求：`B41 = B33 + B35 + B40*B37`
  - 覆盖期 SS：`B42 = 1.65 * $B$23 * SQRT(B38)`
  - 目标水位：`B43 = B41 + B42`
  - 下单量：`B46 = MAX(0, B43 - B44 - B45)`

产品B同理（列区间与单元格参见 `excel_formulas_template.md`）。


## 数据验证与条件格式
- 库存平衡校验（相对误差 ≤ 3%）
```
=ABS((K3-(K2+I3-F3))/K3)<=0.03
```
- 参数合理性（p1/p2 约束）
```
=AND(B24>=0, B24<=1, B25>=0, B25<=1, B24+B25<=1)
```
- 异常值高亮（预测误差列）
```
=ABS(G2)>3*$B$23  // 标红
=ABS(G2)>2*$B$23  // 标黄
```


## 示例说明（A/B 两产品）
- 基于 `mrp_excel.md`（1–7 月样例数据）
  - 产品A：安全库存 ≈ 113.75 千件；9 月下单量 = 0 千件
  - 产品B：安全库存 ≈ 493.45 千件；9 月下单量 ≈ 300.27 千件
- 方法论演示（`计算MRP公式.md`，不同窗口/假设）
  - 产品A：安全库存 ≈ 30.08 千件（示例假设 LT=1.5）
  - 产品B：安全库存 ≈ 50.28 千件

说明：数值差异来自“数据窗口与参数假设”的不同。实施时请统一口径（滚动窗口长度 W、服务水平 Z、LT 估算方式）后再使用。


## 月度更新流程（滚动窗口）
1) 在 RawData 添加最新月份数据；
2) 计算区自动重算 bias、σ_error、p1/p2、LT、H、SS；
3) 检查库存平衡与参数约束是否通过；
4) 在 Summary 查看安全库存与下单量；
5) 备份当前版本并归档。


## 注意事项
- 保护关键公式单元格，避免误删；
- 窗口与口径需统一（W、Z、LT 估算），确保可比性；
- 每月更新前做好备份与校验。


## 参考文档
- `excel_formulas_template.md`
- `mrp_excel.md`
- `计算MRP公式.md`
