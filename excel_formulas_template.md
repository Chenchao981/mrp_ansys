# MRP Excel公式模板

## 工作表结构建议

### Sheet1: 原始数据 (RawData)
从rawdata.xlsx导入的原始数据，按产品分区域排列

### Sheet2: 计算工作表 (Calculations)
包含所有中间计算步骤

### Sheet3: 结果汇总 (Summary)
最终的安全库存和下单建议

## 产品A (LD公司 50KA) Excel公式

### 数据布局 (在Calculations工作表)

#### 基础数据区域 (A1:M20)
```
A1: 月份     B1: 预测量   C1: 交货量   D1: 其他客户  E1: 其他出库  F1: 总需求   G1: 预测误差
A2: 1月      B2: 82.5     C2: 175      D2: 40        E2: 0         F2: =C2+D2+E2  G2: =B2-F2
A3: 2月      B3: 60       C3: 102.5    D3: 17.5      E3: 0.11      F3: =C3+D3+E3  G3: =B3-F3
...继续到7月

H1: 订单量   I1: 收货量   J1: R/O比率   K1: 期末库存
H2: 371.2    I2: 5        J2: =""       K2: 495.977
H3: 0        I3: 282.6    J3: =IF(H2>0,I3/H2,"")  K3: 658.467
H4: 162.4    I4: 80.1     J4: =IF(H3>0,I4/H3,"")  K4: 611.017
...
```

#### 参数计算区域 (A22:D30)
```
A22: 偏差(bias)     B22: =AVERAGE(G2:G8)
A23: 标准差(σ)      B23: =STDEV.S(G2:G8)
A24: p1参数         B24: =MIN(MAX(MEDIAN(J3:J8),0),1)
A25: p2参数         B25: =MAX(0,1-B24)
A26: 提前期(LT)     B26: =1*B24+2*B25
A27: 安全库存(SS)   B27: =1.65*B23*SQRT(B26)
A28: 覆盖期(H)      B28: =1+B26
```

#### 9月下单量计算区域 (A32:D40)
```
A32: 9月预测       B32: 72.5
A33: 9月修正预测   B33: =B32+$B$22
A34: 10月预测      B34: 62.5
A35: 10月修正预测  B35: =B34+$B$22
A36: 11月预测      B36: 60
A37: 11月修正预测  B37: =B36+$B$22

A38: H值           B38: =$B$28
A39: h(整数部分)   B39: =INT(B38)
A40: φ(小数部分)   B40: =B38-B39

A41: 覆盖期需求    B41: =B33+B35+B40*B37
A42: 覆盖期SS      B42: =1.65*$B$23*SQRT(B38)
A43: 目标水位      B43: =B41+B42
A44: 当前库存      B44: 1191.905
A45: 预计到货      B45: =0
A46: 下单量        B46: =MAX(0,B43-B44-B45)
```

## 产品B (B公司 10LL) Excel公式

### 数据布局 (在Calculations工作表，从列F开始)

#### 基础数据区域 (F1:L20)
```
F1: 月份     G1: 交货量   H1: 其他客户  I1: 其他出库  J1: 总需求    K1: 订单量   L1: 收货量   M1: R/O比率
F2: 1月      G2: 189.511  H2: 0         I2: 0.129     J2: =G2+H2+I2  K2: 189.15   L2: 70.171   M2: =""
F3: 2月      G3: 0        H3: 0         I3: 0.605     J3: =G3+H3+I3  K3: 0        L3: 92.253   M3: =IF(K2>0,L3/K2,"")
...继续到7月
```

#### 参数计算区域 (F22:I30)
```
F22: 需求均值        G22: =AVERAGE(J2:J8)
F23: 需求标准差      G23: =STDEV.S(J2:J8)
F24: p1参数          G24: =MIN(MAX(MEDIAN(M3:M8),0),1)
F25: p2参数          G25: =MAX(0,1-G24)
F26: 提前期(LT)      G26: =1*G24+2*G25
F27: 安全库存(SS)    G27: =1.65*G23*SQRT(G26)
F28: 覆盖期(H)       G28: =1+G26
```

#### 9月下单量计算区域 (F32:I40)
```
F32: 历史平均需求   G32: =G22
F33: 覆盖期需求     G33: =G32*G28
F34: 覆盖期SS       G34: =1.65*G23*SQRT(G28)
F35: 目标水位       G35: =G33+G34
F36: 当前库存       G36: 833.824
F37: 预计到货       G37: =G25*146.25+0*0  
F38: 下单量         G38: =MAX(0,G35-G36-G37)
```

## 汇总表 (Summary工作表)

### 结果汇总表格
```
A1: 产品            B1: 安全库存(千件)  C1: 9月下单量(千件)  D1: 备注
A2: 产品A(LD公司50KA)  B2: =Calculations!B27   C2: =Calculations!B46   D2: 库存充足
A3: 产品B(B公司10LL)   B3: =Calculations!G27   C3: =Calculations!G38   D3: 需正常下单
```

## 数据验证公式

### 库存平衡校验 (在Calculations工作表)
```
N1: 库存平衡检查
N2: =ABS((K3-(K2+I3-F3))/K3)<=0.03  // 相对误差≤3%
N3: =ABS((K4-(K3+I4-F4))/K4)<=0.03
...
```

### 参数合理性检查
```
P1: 参数检查
P2: =AND(B24>=0,B24<=1,B25>=0,B25<=1,B24+B25<=1)  // p1,p2约束
P3: =AND(G24>=0,G24<=1,G25>=0,G25<=1,G24+G25<=1)  // 产品B约束
```

## 条件格式设置

### 异常值高亮
```
选择预测误差列(G2:G8): 
条件1: =ABS(G2)>3*$B$23  // 超过3倍标准差，标红
条件2: =ABS(G2)>2*$B$23  // 超过2倍标准差，标黄
```

### 下单量警告
```
选择下单量单元格:
条件: =B46>1000  // 下单量过大警告，标橙色
```

## 图表建议

### 趋势分析图表
```
数据源: G2:G8 (预测误差趋势)
图表类型: 线图
Y轴: 预测误差
X轴: 月份
```

### 库存水位图表
```
数据源: B44,B43,B27 (当前库存,目标水位,安全库存)
图表类型: 柱状图
用于可视化库存状态
```

## 动态更新设置

### 月度更新步骤
1. 在原始数据区域添加新月份数据
2. 公式自动重新计算所有参数
3. 检查数据验证结果
4. 更新下单建议

### 滚动窗口更新
```
// 当有新数据时，调整计算范围
偏差公式: =AVERAGE(OFFSET(G2,MAX(0,ROW()-8),0,6,1))  // 保持6月滚动窗口
标准差公式: =STDEV.S(OFFSET(G2,MAX(0,ROW()-8),0,6,1))
```

## 注意事项

1. **公式保护**: 重要公式单元格设置保护，防止误删
2. **数据验证**: 设置输入单元格的数据验证规则
3. **备份机制**: 每月更新前保存历史版本
4. **文档说明**: 在工作表中添加公式说明和计算逻辑注释

## 快速实施清单

- [ ] 创建三个工作表：RawData, Calculations, Summary
- [ ] 导入原始数据到RawData工作表
- [ ] 在Calculations工作表设置计算公式
- [ ] 配置Summary工作表的结果汇总
- [ ] 设置条件格式和数据验证
- [ ] 测试公式计算结果
- [ ] 建立月度更新流程

这个模板可以直接在Excel中实施，实现MRP系统的自动化计算。
