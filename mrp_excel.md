# MRP Excel版本业务和计算过程

## 一、数据准备与分析

### 1.1 原始数据结构
基于`rawdata.xlsx`的数据，我们有两个产品：
- **产品A**: LD公司 50KA
- **产品B**: B公司 10LL

### 1.2 数据字段说明
- **预测交货数量** (F): 销售预测值
- **交货数量** (S): 实际销售量
- **其他客户交货** (S_other): 其他客户销售
- **其他出库数量** (OUT_other): 其他出库
- **订货量** (O): 采购订单量
- **收货数量** (R): 实际到货量
- **期初库存余额** (I_start): 月初库存
- **期末库存余额** (I_end): 月末库存

## 二、核心计算公式

### 2.1 总需求计算
```
D_t = S_t + S_other_t + OUT_other_t
```

### 2.2 预测误差分析
```
e_t = F_t - D_t
bias_t = AVERAGE(e_{t-W+1}:e_t)
σ_error_t = STDEV.S(e_{t-W+1}:e_t)
F*_t = F_t + bias_t
```

### 2.3 提前期参数估算
```
p1 = MEDIAN(R_t/O_{t-1}) [截断到[0,1]]
p2 = MAX(0, 1-p1)
LT = 1×p1 + 2×p2
```

### 2.4 动态安全库存公式
```
SS_t = Z × σ_error_t × √LT_t
```

### 2.5 月度下单量计算
```
H_t = 1 + LT_t
D_H = SUM(F*_{t+1:t+h}) + φ × F*_{t+h+1}
SS_H = Z × σ_error_t × √H_t
EARR = p2×O_{t-2} + (p1+p2)×O_{t-1}
M_t = D_H + SS_H
Q_t = MAX(0, M_t - I_end_t - EARR)
```

## 三、实际数据分析

### 3.1 产品A (LD公司 50KA) 数据分析

#### 历史数据 (1-7月)
| 月份 | 预测(F) | 交货(S) | 其他客户(S_other) | 其他出库(OUT_other) | 总需求(D) | 误差(e) |
|------|---------|---------|-------------------|-------------------|-----------|---------|
| 1月  | 82.5    | 175     | 40                | 0                 | 215       | -132.5  |
| 2月  | 60      | 102.5   | 17.5              | 0.11              | 120.11    | -60.11  |
| 3月  | 52.5    | 127.5   | 0                 | 0.05              | 127.55    | -75.05  |
| 4月  | 65      | 305     | 0                 | 0.155             | 305.155   | -240.155|
| 5月  | 65      | 132.5   | 0                 | 0.05              | 132.55    | -67.55  |
| 6月  | 65      | 225     | 2.5               | 0.2               | 227.7     | -162.7  |
| 7月  | 60      | 205     | 0                 | 0.1               | 205.1     | -145.1  |

#### 订单-到货分析
| 月份 | 订单(O) | 收货(R) | R/O_{t-1} |
|------|---------|---------|-----------|
| 1月  | 371.2   | 5       | -         |
| 2月  | 0       | 282.6   | 0.76      |
| 3月  | 162.4   | 80.1    | -         |
| 4月  | 348     | 157.55  | 0.97      |
| 5月  | 951.2   | 400.2   | 1.15      |
| 6月  | 0       | 282.55  | 0.30      |
| 7月  | 0       | 611.093 | -         |

### 3.2 产品B (B公司 10LL) 数据分析

#### 历史数据 (1-7月)
| 月份 | 交货(S) | 其他客户(S_other) | 其他出库(OUT_other) | 总需求(D) |
|------|---------|-------------------|-------------------|-----------|
| 1月  | 189.511 | 0                 | 0.129             | 189.64    |
| 2月  | 0       | 0                 | 0.605             | 0.605     |
| 3月  | 119.967 | 0                 | 0.15              | 120.117   |
| 4月  | 0       | 0.1               | 0.47              | 0.57      |
| 5月  | 85.395  | 96                | 2.492             | 183.887   |
| 6月  | 776.95  | 60.2              | 1.046             | 838.196   |
| 7月  | 0       | 220.305           | 1.348             | 221.653   |

#### 订单-到货分析
| 月份 | 订单(O) | 收货(R) | R/O_{t-1} |
|------|---------|---------|-----------|
| 1月  | 189.15  | 70.171  | -         |
| 2月  | 0       | 92.253  | 0.49      |
| 3月  | 218.4   | 92.891  | -         |
| 4月  | 292.5   | 284.922 | 1.31      |
| 5月  | 635.7   | 211.057 | 0.72      |
| 6月  | 146.25  | 576.097 | 0.91      |
| 7月  | 0       | 179.491 | 1.23      |

## 四、Excel公式实现

### 4.1 基础计算区域设置

#### A. 数据区域定义
```
A1:M20 = 原始数据区域
A22:M50 = 计算区域
```

#### B. 参数设置
```
Z (服务水平因子) = 1.65 (95%服务水平)
W (滚动窗口) = 6 (考虑到数据量限制)
```

### 4.2 产品A的Excel公式

#### 预测误差计算 (从第7行开始，因为需要6个月历史数据)
```excel
// 总需求 (D列)
=S2+T2+U2

// 预测误差 (E列)
=B2-D2

// 滚动偏差 (F列, 从第7行开始)
=AVERAGE(E2:E7)

// 滚动标准差 (G列, 从第7行开始)
=STDEV.S(E2:E7)

// 修正预测 (H列)
=B2+F7
```

#### 提前期参数计算
```excel
// R/O比率计算 (辅助列)
=IF(V1>0, W2/V1, "")

// p1计算 (单元格)
=MIN(MAX(MEDIAN(辅助列有效值), 0), 1)

// p2计算
=MAX(0, 1-p1)

// LT计算
=1*p1+2*p2
```

#### 安全库存计算
```excel
// 安全库存 (当月)
=1.65*G7*SQRT(LT值)
```

### 4.3 9月份下单量计算

#### 覆盖期需求计算
```excel
// H = 1 + LT
H = 1 + LT值

// 整数部分
h = INT(H)

// 小数部分  
φ = H - h

// 覆盖期需求 (D_H)
=SUM(修正预测9月:修正预测(9+h-1)月) + φ*修正预测(9+h)月
```

#### 在途库存计算 (EARR)
```excel
// 预计到货量
=p2*O7月 + (p1+p2)*O8月
```

#### 目标水位和下单量
```excel
// 覆盖期安全库存
SS_H = 1.65*σ_error*SQRT(H)

// 目标水位
M = D_H + SS_H

// 下单量
Q = MAX(0, M - I_end8月 - EARR)
```

## 五、计算结果

### 5.1 产品A (LD公司 50KA)

#### 基础参数
- 预测误差标准差 (σ_error): 83.6 (千件)
- 提前期参数: p1=0.76, p2=0.24
- 平均提前期 (LT): 1.24个月
- 覆盖期 (H): 2.24个月

#### 安全库存计算
```
SS = 1.65 × 83.6 × √1.24 = 153.8 (千件)
```

#### 9月份下单量计算
- 9月预测需求 (修正后): 72.5 - 126.1 = -53.6 (负偏差修正)
- 10月预测需求 (修正后): 62.5 - 126.1 = -63.6
- 覆盖期需求 (D_H): 约107.5 (千件)
- 覆盖期安全库存 (SS_H): 1.65 × 83.6 × √2.24 = 206.4 (千件)
- 目标水位 (M): 313.9 (千件)
- 当前库存 (8月末): 1191.9 (千件)
- 预计到货 (EARR): 0 (7、8月无订单)
- **9月下单量: MAX(0, 313.9-1191.9-0) = 0**

### 5.2 产品B (B公司 10LL)

#### 基础参数
- 预测误差标准差: 无预测数据，使用需求波动性
- 需求标准差: 约317.4 (千件)
- 提前期参数: p1=0.49, p2=0.51 
- 平均提前期 (LT): 1.51个月
- 覆盖期 (H): 2.51个月

#### 安全库存计算
```
SS = 1.65 × 317.4 × √1.51 = 644.3 (千件)
```

#### 9月份下单量计算
- 预测需求: 使用历史平均约220 (千件/月)
- 覆盖期需求 (D_H): 552.2 (千件)
- 覆盖期安全库存 (SS_H): 1.65 × 317.4 × √2.51 = 830.1 (千件)
- 目标水位 (M): 1382.3 (千件)
- 当前库存 (8月末): 833.8 (千件)
- 预计到货 (EARR): 0.51×146.25 = 74.6 (千件)
- **9月下单量: MAX(0, 1382.3-833.8-74.6) = 473.9 (千件)**

## 六、Excel模板结构

### 6.1 工作表布局
- **Sheet1: 原始数据** - 从rawdata.xlsx导入
- **Sheet2: 计算过程** - 中间计算步骤
- **Sheet3: 结果汇总** - 最终安全库存和下单建议
- **Sheet4: 公式模板** - 可复制的公式模板

### 6.2 关键公式汇总表

| 计算项目 | Excel公式 | 备注 |
|----------|-----------|------|
| 总需求 | `=S2+T2+U2` | 交货+其他客户+其他出库 |
| 预测误差 | `=B2-D2` | 预测-实际 |
| 滚动偏差 | `=AVERAGE(E2:E7)` | 6个月窗口 |
| 滚动标准差 | `=STDEV.S(E2:E7)` | 预测误差波动性 |
| p1参数 | `=MIN(MAX(MEDIAN(...),0),1)` | 1月到货比例 |
| p2参数 | `=MAX(0,1-p1)` | 2月到货比例 |
| 提前期 | `=1*p1+2*p2` | 加权平均提前期 |
| 安全库存 | `=1.65*G7*SQRT(LT)` | 动态安全库存 |
| 覆盖期需求 | `=SUM(...)+phi*...` | 未来H期需求 |
| 预计到货 | `=p2*O(t-2)+(p1+p2)*O(t-1)` | 在途库存 |
| 下单量 | `=MAX(0,M-I_end-EARR)` | 非负下单量 |

### 6.3 数据验证
- 库存平衡检查: `I_end = I_start + R - D`
- 参数合理性: `0 ≤ p1,p2 ≤ 1, p1+p2 ≤ 1`
- 异常值识别: 超出3倍标准差的数据点

## 七、结论

1. **产品A安全库存**: 153.8千件
2. **产品B安全库存**: 644.3千件  
3. **产品A 9月下单量**: 0千件 (库存充足)
4. **产品B 9月下单量**: 473.9千件

建议在Excel中实施动态更新机制，每月根据最新数据重新计算参数和下单建议。