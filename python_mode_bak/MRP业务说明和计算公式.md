## MRP业务说明和计算公式（动态安全库存 + 1–2月提前期 + 两期在途拆分）

### 目标与范围

- **目标**: 在月度订货节奏下，结合销售预测与实际数据，计算动态安全库存与次月下单量，确保给定服务水平下的供货可靠性，避免缺货与过量。
- **适用前提**:
  - 每月下单一次（审视周期 \(P=1\) 月）。
  - 订单到货提前期 \(LT\) 在 1–2 个月之间浮动。
  - 可获得“预测交货数量”（销售输入）、“订货量、收货数量、交货数量、其他客户交货、其他出库数量、期初/期末库存”等实际数据。

---

## 一、数据字典与字段映射（对应 `rawdata.txt`）

针对每个产品（如 `LD公司 50KA`、`B公司 10LL`），按月建立下列时间序列：

- **预测相关**
  - \(F_t\): 预测交货数量（`预测数据/预测交货数量`）。若缺失，使用移动平均或季节性方法外推。

- **实际需求与库存**
  - \(S_t\): 实际交货数量（`实际数据/交货数量`）。
  - \(S^{other}_t\): 其他客户交货（`实际数据/其他客户交货`）。
  - \(OUT^{other}_t\): 其他出库数量（`实际数据/其他出库数量`）。
  - \(D_t\): 实际总消耗（总需求），定义为：
    \[ D_t = S_t + S^{other}_t + OUT^{other}_t \]
  - \(I^{start}_t\): 期初库存余额（`实际数据/期初库存余额`）。
  - \(I^{end}_t\): 期末库存余额（`实际数据/期末库存余额`）。

- **订单与到货**
  - \(O_t\): 订货量（`实际数据/订货量`）。
  - \(R_t\): 收货数量（`实际数据/收货数量`）。

- **月度库存平衡校验**（用于数据质检）
  \[ I^{end}_t = I^{start}_t + R_t - D_t \]
  若偏差超出容忍阈值（建议 ≤ 1–3%），需回溯修正明细或异常。

---

## 二、动态安全库存的核心参数（滚动更新）

- **服务水平因子** \(Z\): 由业务策略设定（如 95% 对应 \(Z=1.65\)）。
- **滚动窗口** \(W\): 计算预测误差统计的月数。建议 \(W\in[6,12]\)，数据少时≥6。
- **预测误差与偏差修正**
  - 月度预测误差：\(e_t = F_t - D_t\)
  - 偏差（Bias）估计：\( \text{bias}_t = \text{avg}(e_{t-W+1},\dots,e_t) \)
  - 偏差修正后的预测：\( F^*_t = F_t + \text{bias}_t \)
  - 误差标准差（波动性）：\( \sigma_{error,t} = \operatorname{stdev}(e_{t-W+1},\dots,e_t) \)

- **提前期分布（两期在途拆分）**
  - 假设到货在下月/下下月分布：比例分别为 \(p_1\)（1月到）与 \(p_2\)（2月到），且 \(p_1, p_2 \ge 0\)，通常 \(p_1+p_2 \le 1\)。
  - 用历史“订货量→收货量”的关系估计 \(p_1, p_2\)：
    \[ \min_{p_1,p_2}\; \sum_t \big(R_t - p_1 O_{t-1} - p_2 O_{t-2}\big)^2 \quad \text{s.t.}\; p_1,p_2\ge0,\; p_1+p_2\le1 \]
    若实现复杂，可用鲁棒近似：
    - \(p_1 = \operatorname{median}\{ R_t / O_{t-1}\;|\;O_{t-1}>0 \}\)（截断到 \([0,1]\)）
    - \(p_2\) 由最小二乘拟合剩余或经验设定（如 \(p_2=\max(0,1-p_1)\)）。
  - 动态平均提前期：\( LT_t = 1\cdot p_1 + 2\cdot p_2 \)。

---

## 三、动态安全库存公式

按月滚动计算，在时间点 \(t\)：

\[ SS_t = Z \times \sigma_{error,t} \times \sqrt{LT_t} \]

说明：安全库存输入完全动态（\(\sigma_{error,t}\)、\(LT_t\) 每月重估；\(Z\) 通常按季度/年度评审）。

---

## 四、周期性订货（每月一次）的“目标库存水位法”

在月初 \(t\) 决策次月下单量（发单即刻），采用 Order-Up-To（订至目标上限）框架：

1) 定义审视周期 \(P=1\) 月；动态提前期 \(LT_t\) 来自上一节；
   \[ H_t = P + LT_t \]
   对于 \(LT_t\in[1,2]\)，有 \(H_t\in[2,3]\)。

2) 计算覆盖 \(H_t\) 期的预测需求（偏差修正后）：
   - 设 \(h = \lfloor H_t \rfloor\)，\(\phi = H_t - h\)（0–1 的小数部分）。
   - \[ D_{H_t} = \sum_{k=1}^{h} F^*_{t+k} + \phi \cdot F^*_{t+h+1} \]

3) 计算覆盖 \(H_t\) 的安全库存：
   \[ SS_{H_t} = Z \times \sigma_{error,t} \times \sqrt{H_t} \]

4) 期末在手库存（下单前）：\(I^{end}_t\)。

5) 预计在 \(H_t\) 内可到货的在途量（仅依赖过去两期已下单）
   - 由于实际到货提前期为 1–2 个月，且本期下单尚未执行到货，故在 \(H_t\in[2,3]\) 内仅考虑历史两期：
   \[ EARR_{t,H_t} = p_2\,O_{t-2} + (p_1 + p_2)\,O_{t-1} \]
   解释：\(O_{t-2}\) 的“第2个月”在本期起始到；\(O_{t-1}\) 的“第1个月”和“第2个月”均在 \([t, t+2]\) 内到达。当前期 \(O_t\) 的到货（1–2个月后）不计入本次决策的覆盖期内。

6) 目标库存水位：
   \[ M_t = D_{H_t} + SS_{H_t} \]

7) 次月下单量（非负截断）：
   \[ Q_t = \max\big(0,\; M_t - I^{end}_t - EARR_{t,H_t} \big) \]

> 若 \(Q_t<0\)，表示当前“在手 + 预计到货”已覆盖目标水位，本期无需下单（置 0）。

---

## 五、实现细节（Excel 与程序）

- **滚动更新顺序（每月）：**
  1. 更新上月实际的 \(S_t, S^{other}_t, OUT^{other}_t, R_t, I^{end}_t\)。
  2. 计算 \(D_t\)，校验库存平衡式。
  3. 以最近 \(W\) 个月误差 \(e_t\) 计算 \(\text{bias}_t, \sigma_{error,t}\)，得到 \(F^*\)。
  4. 用最新 \(O, R\) 估计 \(p_1, p_2\)，进而得到 \(LT_t\) 与 \(H_t\)。
  5. 聚合 \(D_{H_t}\)、\(SS_{H_t}\)、\(EARR_{t,H_t}\)，求 \(Q_t\)。

- **Excel 函数提示**（示例，按列表示月份，命名区域按产品维度）：
  - 偏差：`BIAS_t = AVERAGE(e_{t-W+1}:e_t)`
  - 误差标准差：`SIGMA_t = STDEV.S(e_{t-W+1}:e_t)`
  - 修正预测：`F*_k = F_k + BIAS_t`
  - 简化 \(p_1\)：`P1 = MEDIAN( FILTER(R_{2:K} / O_{1:K-1}, O_{1:K-1}>0) )`，再 `MIN(MAX(P1,0),1)` 截断
  - 简化 \(p_2\)：`P2 = MAX(0, 1 - P1)`（或再做一次回归微调）
  - \(LT\)：`LT = 1*P1 + 2*P2`
  - \(H\)：`H = 1 + LT`，`f = H - 2`
  - `D_H = SUM(F*_{t+1:t+h}) + phi * F*_{t+h+1}`
  - `SS_H = Z * SIGMA_t * SQRT(H)`
  - `EARR = P2*O_{t-2} + (P1 + P2)*O_{t-1}`
  - `Q = MAX(0, D_H + SS_H - I_end_t - EARR)`

- **程序伪代码**（按产品循环）：
  ```pseudo
  inputs: F[ ], O[ ], R[ ], S[ ], S_other[ ], OUT_other[ ], I_start[ ], I_end[ ], Z, W
  D[t] = S[t] + S_other[t] + OUT_other[t]
  assert approx_equal(I_end[t], I_start[t] + R[t] - D[t])

  e_window = [ F[k] - D[k] for k in t-W+1..t ]
  bias = mean(e_window)
  sigma = stdev(e_window)
  F_star[k] = F[k] + bias

  # 估计 p1, p2（可用 NNLS；简化：median 比率 + 1-p1）
  p1 = clamp(median( R[k] / O[k-1] for k with O[k-1]>0 ), 0, 1)
  p2 = max(0, 1 - p1)

  LT = 1*p1 + 2*p2
  H  = 1 + LT         # P=1
  h  = floor(H); phi = H - h; f = max(0, H - 2)

  D_H = sum(F_star[t+1 .. t+h]) + phi * F_star[t+h+1]
  SS_H = Z * sigma * sqrt(H)
  EARR = p2*O[t-2] + (p1 + p2)*O[t-1]

  Q = max(0, D_H + SS_H - I_end[t] - EARR)
  ```

---

## 六、与 `rawdata.txt` 的落地要点

- `LD公司 50KA`：已有完整的“预测交货数量”（1–12月）与实际数据（1–7月）。可直接滚动计算 \(e_t\)、\(\sigma_{error,t}\)、\(p_1,p_2\)。
- `B公司 10LL`：若预测缺失，可先用“最近 \(m\) 月（建议 3–6）实际总消耗 \(D_t\) 的移动平均”作为临时 \(F_t\)，随后再迭代引入销售预测。
- `其他客户交货`与`其他出库数量`均视为对库存的消耗，纳入 \(D_t\)。
- 建议按产品维度独立估计 \(p_1,p_2\) 与 \(\sigma_{error}\)，避免“一刀切”。

---

## 七、参数建议与边界条件

- **服务水平**：
  - 关键物料：\(Z=1.65\)（95%），或更高（97.5% → \(Z\approx1.96\)）。
  - 常规物料：\(Z=1.28\)（90%）。

- **窗口宽度 \(W\)**：
  - 数据充足：12；样本较少：6–9；季节性明显时使用整年整数倍。

- **健壮性**：
  - 缺失或异常月：用中位数/分位数替代；
  - 上限/下限：\(0\le p_1,p_2\le1\)，\(p_1+p_2\le1\)，\(Q_t\ge0\)。
  - 若 \(H_t<2\) 的极端情况，可将 \(EARR\) 简化为 \(p_1 O_t\) 的线性插值；但本业务典型区间为 \([2,3]\)，可直接采用上式。

---

## 八、交付物与对接

- 本文档即为“MRP 业务说明 + 计算口径”统一规范，后续开发应：
  - 严格按变量命名与口径实现；
  - 产出每月计算明细（含 \(D_t,e_t,\sigma_{error,t},p_1,p_2,LT_t,H_t,D_{H_t},SS_{H_t},EARR,Q_t\)）；
  - 导出异常与质检报告（库存平衡偏差、异常比率、极端 \(Q_t\) 变动）。

---

## 九、快速校验清单（Check List）

- 已完成数据平衡式校验：\(I^{end}_t \approx I^{start}_t + R_t - D_t\)
- \(e_t\)、\(\sigma_{error,t}\)、\(\text{bias}_t\) 按滚动窗口更新
- \(p_1,p_2\) 由 \(O\to R\) 动态估计，\(LT_t= p_1 + 2p_2\)
- \(H_t=1+LT_t\)，\(D_{H_t}\)、\(SS_{H_t}\) 正确聚合
- \(EARR=p_2O_{t-1} + (p_1+f p_2)O_t\)（\(f=H_t-2\)）
- \(Q_t = \max(0, D_{H_t}+SS_{H_t}-I^{end}_t-EARR)\)

---

若需，我可以基于该口径直接生成一个 Excel/脚本模板，对 `50KA` 与 `10LL` 做首轮跑数与可视化校验。


